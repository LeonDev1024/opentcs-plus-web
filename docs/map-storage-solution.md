# 地图编辑器存储方案说明

## 一、存储方案选择

### 推荐方案：混合存储（数据库 + 文件）

基于现有系统已有 `filePath` 字段，采用**混合存储方案**：

### 存储架构

```
┌─────────────────────────────────────────┐
│         数据库（MySQL/PostgreSQL）      │
├─────────────────────────────────────────┤
│  MapModel 表                            │
│  - id, name, version, description       │
│  - filePath (指向文件路径)              │
│  - status, createTime                   │
├─────────────────────────────────────────┤
│  Point 表                               │
│  - id, name, code, x, y, z              │
│  - type, status                         │
├─────────────────────────────────────────┤
│  Path 表                                │
│  - id, name, code                       │
│  - startPointId, endPointId             │
│  - length, type, status                 │
├─────────────────────────────────────────┤
│  Location 表                            │
│  - id, name, code                       │
│  - locationTypeId, x, y, z              │
│  - blockId, status                      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         文件系统（JSON/XML 文件）        │
├─────────────────────────────────────────┤
│  /maps/{mapModelId}/                    │
│  ├── map_v1.0.json (当前版本)           │
│  ├── map_v1.0_backup.json (备份)        │
│  └── versions/                          │
│      ├── map_v1.0.json                  │
│      ├── map_v1.1.json                  │
│      └── ...                            │
└─────────────────────────────────────────┘
```

## 二、数据存储分工

### 2.1 数据库存储（元数据和业务数据）

**用途：**
- 快速查询和列表展示
- 业务逻辑关联（如订单关联路径、车辆关联位置）
- 权限控制和审计
- 状态管理

**存储内容：**
- 地图模型基本信息（MapModel 表）
- 点、路径、位置的业务属性（Point/Path/Location 表）
- 关联关系（外键）

### 2.2 文件存储（完整编辑器数据）

**用途：**
- 完整的地图几何数据
- 编辑器扩展属性（颜色、样式等）
- 图层信息
- 版本历史

**存储内容：**
- 完整的 `MapEditorData` 结构
- 所有控制点、顶点坐标
- 编辑器属性（颜色、透明度等）
- 图层配置

## 三、数据流转流程

### 3.1 保存流程

```
编辑器修改数据
    ↓
1. 更新编辑器数据（内存）
    ↓
2. 保存到文件（完整数据）
   POST /map/model/{id}/editor-data/upload
    ↓
3. 同步到数据库（业务数据）
   - 提取 Point/Path/Location 业务属性
   - 更新或插入到对应表
    ↓
4. 更新 MapModel.filePath
```

### 3.2 加载流程

```
打开地图编辑器
    ↓
1. 从数据库加载 MapModel 基本信息
   GET /map/model/{id}
    ↓
2. 从文件加载完整编辑器数据
   GET /map/model/{id}/editor-data/download
    ↓
3. 从数据库加载实体数据（可选，用于合并）
   GET /map/point/list?mapModelId={id}
   GET /map/path/list?mapModelId={id}
   GET /map/location/list?mapModelId={id}
    ↓
4. 合并数据（文件数据为主，数据库数据补充业务属性）
    ↓
5. 渲染到编辑器
```

## 四、文件格式

### 4.1 JSON 格式（推荐）

```json
{
  "mapInfo": {
    "id": "1",
    "name": "安庆试验场1F",
    "version": "1.0",
    "width": 1920,
    "height": 1080
  },
  "layers": [
    {
      "id": "layer1",
      "name": "点位层",
      "type": "point",
      "visible": true,
      "locked": false,
      "zIndex": 1
    }
  ],
  "elements": {
    "points": [
      {
        "id": "point1",
        "layerId": "layer1",
        "name": "起点",
        "x": 100,
        "y": 200,
        "editorProps": {
          "radius": 5,
          "color": "#1890ff"
        }
      }
    ],
    "paths": [],
    "locations": []
  }
}
```

### 4.2 XML 格式（兼容 OpenTCS）

如果需要兼容 OpenTCS 标准格式，可以转换为 XML：

```xml
<mapModel id="1" name="安庆试验场1F" version="1.0">
  <layers>
    <layer id="layer1" name="点位层" type="point"/>
  </layers>
  <elements>
    <points>
      <point id="point1" name="起点" x="100" y="200"/>
    </points>
  </elements>
</mapModel>
```

## 五、版本管理

### 5.1 文件版本管理

```
/maps/{mapModelId}/
  ├── map_v1.0.json          # 当前版本
  ├── map_v1.0_backup.json   # 自动备份
  └── versions/              # 历史版本
      ├── map_v1.0.json
      ├── map_v1.1.json
      └── map_v2.0.json
```

### 5.2 版本控制策略

1. **自动备份**：每次保存前自动备份当前版本
2. **版本创建**：用户手动创建版本时，复制到 versions 目录
3. **版本恢复**：可以从历史版本恢复
4. **版本对比**：可以对比不同版本的差异

## 六、数据一致性保证

### 6.1 同步策略

1. **文件为主，数据库为辅**
   - 编辑器数据以文件为准
   - 数据库用于业务查询和关联

2. **保存时同步**
   - 保存文件成功后，同步更新数据库
   - 使用事务保证一致性

3. **加载时合并**
   - 优先从文件加载
   - 数据库数据用于补充业务属性

### 6.2 冲突处理

如果文件数据和数据库数据不一致：
- **编辑器打开时**：以文件数据为准
- **保存时**：文件数据覆盖数据库数据
- **提供手动同步功能**：用户可以手动触发同步

## 七、性能优化

### 7.1 文件大小控制

- 大文件分块加载
- 使用压缩（gzip）
- 增量更新（只保存变更部分）

### 7.2 缓存策略

- 浏览器缓存：已加载的地图数据缓存到 IndexedDB
- 服务端缓存：文件内容缓存到 Redis
- CDN 加速：静态文件通过 CDN 分发

## 八、安全性

### 8.1 文件访问控制

- 文件存储在受保护的目录
- 通过 API 访问，不直接暴露文件路径
- 权限验证：检查用户是否有权限访问该地图

### 8.2 数据校验

- 文件格式校验
- 数据完整性校验
- 防止恶意文件上传

## 九、迁移方案

如果现有系统是纯数据库存储，可以这样迁移：

1. **导出现有数据**：从数据库导出所有地图数据
2. **转换为文件格式**：转换为 JSON 格式
3. **上传文件**：保存到文件系统
4. **更新 filePath**：更新 MapModel 表的 filePath 字段
5. **逐步切换**：新功能使用文件存储，旧功能保持兼容

## 十、总结

**混合存储方案的优势：**
- ✅ 查询性能好（数据库）
- ✅ 完整数据存储（文件）
- ✅ 版本管理方便（文件）
- ✅ 业务关联方便（数据库）
- ✅ 兼容现有系统（已有 filePath 字段）

**适用场景：**
- 地图数据量大
- 需要版本管理
- 需要离线编辑
- 需要与业务系统集成

