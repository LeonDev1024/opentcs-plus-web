import{d as Mt,r as x,N as _,ag as Ie,k as pe,b as Ot,n as J,Z as Rt,O as ee,c as W,o as h,m as I,I as Ae,q as j,t as D,x as O,F as G,A as ue,e as Wt,E as X,M as $t}from"./index-B9WM9B43.js";import{u as Ht,T as l,A as Kt}from"./mapEditor-C3208Y0J.js";import"./index-BJgmA4Qg.js";function Yt(k,P){return{x:Math.round(k.x/P)*P,y:Math.round(k.y/P)*P,z:k.z}}function zt(k,P,g=10){let s=1/0,w=null;for(const b of P){const m=Math.sqrt(Math.pow(k.x-b.x,2)+Math.pow(k.y-b.y,2));m<g&&m<s&&(s=m,w=b)}return w||k}function Gt(k,P){const{start:g,end:s}=P,w=k.x-g.x,b=k.y-g.y,m=s.x-g.x,A=s.y-g.y,R=w*m+b*A,$=m*m+A*A;let S=-1;$!==0&&(S=R/$);let B,V;S<0?(B=g.x,V=g.y):S>1?(B=s.x,V=s.y):(B=g.x+S*m,V=g.y+S*A);const T=k.x-B,f=k.y-V;return Math.sqrt(T*T+f*f)}function Xt(k,P){const{start:g,end:s}=P,w=k.x-g.x,b=k.y-g.y,m=s.x-g.x,A=s.y-g.y,R=w*m+b*A,$=m*m+A*A;let S=-1;return $!==0&&(S=R/$),S<0?{x:g.x,y:g.y,z:g.z}:S>1?{x:s.x,y:s.y,z:s.z}:{x:g.x+S*m,y:g.y+S*A,z:g.z}}function Bt(k,P,g=10){let s=1/0,w=null;for(const b of P){const m=Gt(k,b);m<g&&m<s&&(s=m,w=Xt(k,b))}return w||k}function Ne(k,P){var s,w;let g={...k};return P.snapToGrid&&P.gridSize&&(g=Yt(g,P.gridSize)),P.snapToPoint&&P.targetPoints&&(g=zt(g,P.targetPoints,((s=P.thresholds)==null?void 0:s.point)||10)),P.snapToLine&&P.targetLines&&(g=Bt(g,P.targetLines,((w=P.thresholds)==null?void 0:w.line)||10)),g}const Vt=250,Ut=Mt({__name:"MapCanvas",emits:["point-double-click"],setup(k,{expose:P,emit:g}){const s=Ht(),w=g,b=x(),m=x(),A=x(),R=x(),$=x(),S=x(),B=x(),V=x(),T=e=>e?e.getNode&&typeof e.getNode=="function"?e.getNode():e.$konva?e.$konva:e.getStage&&typeof e.getStage=="function"?e.getStage():e.findOne?e:null:null,f=_(()=>s.canvasState),d=_(()=>s.currentTool),Me=_(()=>{var o,n;const e=((o=b.value)==null?void 0:o.clientWidth)||1920,t=((n=b.value)==null?void 0:n.clientHeight)||1080;return{width:e,height:t,scaleX:f.value.scale,scaleY:f.value.scale,x:f.value.offsetX,y:f.value.offsetY,draggable:!1}}),Oe=_(()=>{const e=f.value.width||1920,t=f.value.height||1080,o=Math.round(e/2/(N.value||20))*(N.value||20),n=Math.round(t/2/(N.value||20))*(N.value||20);return{x:o,y:n,radius:6,stroke:"#ff4d4f",strokeWidth:2,fill:"#ffffff",listening:!1}}),xe=_(()=>{const e=f.value.width||1920,t=f.value.height||1080,o=N.value||20,n=Math.round(e/2/o)*o,i=Math.round(t/2/o)*o;return{horizontal:{points:[0,i,e,i],stroke:"#ff7875",strokeWidth:1.5,dash:[8,6],listening:!1},vertical:{points:[n,0,n,t],stroke:"#ff7875",strokeWidth:1.5,dash:[8,6],listening:!1}}}),Re=_(()=>({x:0,y:0,width:f.value.width||1920,height:f.value.height||1080,fill:"#ffffff",listening:!1})),N=x(20),te=x(!0),ke=_(()=>{if(!te.value)return[];const e=[],t=f.value.width||1920,o=f.value.height||1080,n=N.value,i=n*20,a=Math.floor(-i/n)*n,c=Math.ceil((t+i)/n)*n,u=Math.floor(-i/n)*n,v=Math.ceil((o+i)/n)*n;for(let r=a;r<=c;r+=n)e.push({points:[r,u,r,v],stroke:"#cccccc",strokeWidth:1,listening:!1,perfectDrawEnabled:!1,hitStrokeWidth:0});for(let r=u;r<=v;r+=n)e.push({points:[a,r,c,r],stroke:"#cccccc",strokeWidth:1,listening:!1,perfectDrawEnabled:!1,hitStrokeWidth:0});return e}),Le=_(()=>s.points.filter(e=>{const t=s.layers.find(o=>o.id===e.layerId);return(t==null?void 0:t.visible)!==!1})),We=_(()=>s.paths.filter(e=>{const t=s.layers.find(o=>o.id===e.layerId);return(t==null?void 0:t.visible)!==!1})),$e=_(()=>s.locations.filter(e=>{const t=s.layers.find(o=>o.id===e.layerId);return(t==null?void 0:t.visible)!==!1})),ye={HALT:"Halt point",PARK:"Park point"},fe=e=>{const t={fill:e.editorProps.color||"#1890ff",stroke:e.editorProps.strokeColor||"#ffffff",strokeWidth:1.2,radius:e.editorProps.radius||5,glyph:void 0,glyphColor:e.editorProps.textColor||"#606266"};return e.type===ye.PARK?(t.fill=e.editorProps.color||"#409eff",t.stroke=e.editorProps.strokeColor||"#1d6fd6",t.strokeWidth=1.6,t.radius=e.editorProps.radius||7,t.glyph="P",t.glyphColor=e.editorProps.textColor||"#ffffff"):e.type===ye.HALT&&(t.fill=e.editorProps.color||"#8c8c8c",t.stroke=e.editorProps.strokeColor||"#d9d9d9",t.radius=e.editorProps.radius||5,t.strokeWidth=1.4),t},He=e=>!!fe(e).glyph,Ke=e=>{var o;const t=((o=e.editorProps)==null?void 0:o.labelVisible)!==!1;return ge.value&&t&&(e.name||e.id)},Ye=e=>{const t=fe(e),o=e.name||e.id,n=s.selection.selectedIds.has(e.id);return{x:e.x,y:e.y+t.radius+8,text:o,fontSize:12,fontFamily:"Arial, sans-serif",fill:n?"#ff4d4f":"#303133",align:"center",verticalAlign:"top",padding:2,listening:!1,perfectDrawEnabled:!1}},ze=e=>{var a;const t=fe(e);if(!t.glyph)return{};const o=s.selection.selectedIds.has(e.id),n=d.value===l.PATH&&((a=p.startPoint)==null?void 0:a.id)===e.id,i=o||n;return{x:e.x,y:e.y,text:t.glyph,fontSize:Math.max(10,t.radius*1.8),fontStyle:"bold",fill:i?"#ffffff":t.glyphColor,align:"center",verticalAlign:"middle",width:t.radius*2,height:t.radius*2,offsetX:t.radius,offsetY:t.radius,listening:!1}},Ge=e=>e===ye.PARK?{radius:7,color:"#409eff",strokeColor:"#1d6fd6",textColor:"#ffffff",labelVisible:!0}:{radius:5,color:"#8c8c8c",strokeColor:"#d9d9d9",textColor:"#595959",labelVisible:!0},Xe=(e,t)=>{const o=typeof s.generatePointName=="function"?s.generatePointName():`Point-${Date.now()}`;return{layerId:le(),name:o,x:e,y:t,status:"0",type:s.pointType,editorProps:Ge(s.pointType)}},he=x({x:0,y:0}),se=x(null),H=x(!1),E=x([]),K=x(null),de=x(!1),U=x(null),oe=x(null),p=Ie({startPoint:null,currentPos:{x:0,y:0},pathType:"direct"}),q={radius:6,color:"#409eff"},ie=_(()=>{if(!p.startPoint)return null;const e=p.startPoint,t={x:p.currentPos.x,y:p.currentPos.y},o=Ce(e,t,p.pathType),n=[];o.forEach(v=>{n.push(v.x,v.y)});const i={points:n,stroke:"#409eff",strokeWidth:2,lineCap:"round",lineJoin:"round",dash:[8,8]},a={points:[o[o.length-2].x,o[o.length-2].y,t.x,t.y],pointerLength:q.radius*2.5,pointerWidth:q.radius*1.6,fill:q.color,stroke:q.color,strokeWidth:2},c={x:e.x,y:e.y,radius:q.radius,stroke:"#73c0ff",strokeWidth:2,fill:"rgba(64, 158, 255, 0.15)"},u={x:t.x,y:t.y,radius:q.radius,stroke:"#409eff",strokeWidth:2,fill:"rgba(94, 200, 255, 0.2)"};return{line:i,arrow:a,startMarker:c,endMarker:u}}),re=(e,t,o=1.6)=>{for(const n of Le.value){const i=n.editorProps.radius||5;if(Math.hypot(n.x-e,n.y-t)<=i*o)return n}return null},Z=e=>{const t=T(V.value);t&&(t.getChildren().forEach(a=>{a.destroy()}),t.clear()),Object.assign(p,{startPoint:null,currentPos:{x:0,y:0},pathType:"direct"}),oe.value=null;const o=e||T(m.value);o&&o.container&&(o.container().style.cursor="default");const n=T(m.value);n&&n.batchDraw(),J(()=>{const i=T(V.value),a=T(m.value);i&&(i.getChildren().forEach(u=>{u.destroy()}),i.clear(),i.batchDraw()),a&&a.batchDraw()})},ae=e=>{const t=T(m.value);t&&t.container&&(t.container().style.cursor=e)},L=Ie({startLocation:null,currentPos:{x:0,y:0}}),ne=x(null),Y=x(!1),ve=x({x:0,y:0}),Be=e=>s.paths.some(t=>{const o=String(t.startPointId||""),n=String(t.endPointId||""),i=String(e.id);return o===i||n===i}),Ve=e=>{var y;const t=s.selection.selectedIds.has(e.id),o=d.value===l.PATH&&((y=p.startPoint)==null?void 0:y.id)===e.id,n=d.value===l.PATH&&oe.value===e.id&&!o,i=d.value===l.DASHED_LINK&&L.startLocation&&oe.value===e.id,a=Be(e),c=fe(e);let u=c.fill,v=c.stroke,r=c.strokeWidth;return t?(u="#ff4d4f",v="#ff7875",r=Math.max(2,r)):o?(u="#409eff",v="#73c0ff",r=Math.max(2.2,r)):n?(u="#73c0ff",v="#73c0ff",r=Math.max(2,r)):i?(u="#f7ba2a",v="#f5d48f",r=Math.max(2,r)):a&&(u="#73c0ff",v="#73c0ff",r=Math.max(1.5,r)),{id:e.id,x:e.x,y:e.y,radius:c.radius,fill:u,stroke:v,strokeWidth:r,draggable:d.value===l.SELECT&&!Y.value,listening:!0}},Ue=e=>{const t=s.selection.selectedIds.has(e.id),o=[];e.geometry.controlPoints.forEach(c=>{o.push(c.x,c.y)});const n=e.type,i=e.geometry.pathType==="curve"||n==="curve",a=n==="orthogonal";return{id:e.id,points:o,stroke:t?"#ff4d4f":e.editorProps.strokeColor||"#73c0ff",strokeWidth:e.editorProps.strokeWidth||2,lineCap:"round",lineJoin:a?"miter":"round",tension:i?.5:0,dash:e.editorProps.lineStyle==="dashed"?[5,5]:void 0,listening:!0}},qe=e=>e.editorProps.arrowVisible!==!1,Fe=e=>{const t=e.geometry.controlPoints;if(!t||t.length<2)return null;const o=t[t.length-1],n=t[t.length-2],a=s.selection.selectedIds.has(e.id)?"#ff4d4f":e.editorProps.strokeColor||"#73c0ff";return{points:[n.x,n.y,o.x,o.y],pointerLength:q.radius*2.2,pointerWidth:q.radius*1.5,fill:a,stroke:a,strokeWidth:e.editorProps.strokeWidth||2}},Ce=(e,t,o)=>{const n=Date.now();let i=0;const a=(u,v)=>({id:`cp_${n}_${i++}`,x:u,y:v}),c=[a(e.x,e.y)];if(o==="orthogonal"&&e.x!==t.x&&e.y!==t.y)c.push(a(e.x,t.y));else if(o==="curve"){const u=t.x-e.x,v=t.y-e.y,r=Math.hypot(u,v)||1,y=-v/r,M=u/r,C=Math.min(80,r/3),At=(e.x+t.x)/2+y*C,Nt=(e.y+t.y)/2+M*C;c.push(a(At,Nt))}return c.push(a(t.x,t.y)),c},be=e=>e.name||e.id,Je=(e,t)=>{const o=s.pathConnectionType,n=Ce(e,t,o),i=be(e),a=be(t),c=`Path ${i} --- ${a}`;s.addPath({layerId:le(),name:c,startPointId:e.id,endPointId:t.id,status:"0",type:o,geometry:{controlPoints:n,pathType:o==="curve"?"curve":"line"},editorProps:{strokeColor:"#73c0ff",strokeWidth:2,lineStyle:"solid",arrowVisible:!0,labelVisible:!0}}),X.success("连线创建成功")},z=e=>{const t=e.geometry.vertices||[];if(!t.length)return{x:e.x??0,y:e.y??0};const o=t.reduce((n,i)=>(n.x+=i.x,n.y+=i.y,n),{x:0,y:0});return{x:o.x/t.length,y:o.y/t.length}},Pe=e=>{var n,i;const t=(n=e.editorProps)==null?void 0:n.strokeColor,o=(i=e.editorProps)==null?void 0:i.fillColor;return t==="#ff7d00"||o==="#ffedd9"},je=e=>{const t=z(e),o=s.selection.selectedIds.has(e.id),n=40,i=n/2;return{x:t.x-i,y:t.y-i,width:n,height:n,stroke:o?"#409eff":"#000000",strokeWidth:2,fill:"#ffffff",listening:!0}},Ze=e=>{var i;const t=z(e),o=s.selection.selectedIds.has(e.id),n=((i=e.editorProps)==null?void 0:i.label)||"";return{x:t.x,y:t.y,text:n,fontSize:16,fontStyle:"bold",fill:o?"#ff4d4f":"#000000",align:"center",verticalAlign:"middle",listening:!1}},Qe=e=>{var o;const t=((o=e.editorProps)==null?void 0:o.labelVisible)!==!1;return ge.value&&t&&(e.name||e.id)},et=e=>{const t=z(e),o=e.name||e.id,n=s.selection.selectedIds.has(e.id),i=Pe(e)?15:20;return{x:t.x,y:t.y+i,text:o,fontSize:12,fontFamily:"Arial, sans-serif",fill:n?"#ff4d4f":"#303133",align:"center",verticalAlign:"top",padding:2,listening:!1,perfectDrawEnabled:!1}},Te=_(()=>{if(!L.startLocation)return null;const e=z(L.startLocation),t={x:L.currentPos.x,y:L.currentPos.y};return{points:[e.x,e.y,t.x,t.y],stroke:"#909399",strokeWidth:1.5,lineCap:"round",lineJoin:"round",dash:[5,5],listening:!1}}),De=(e,t)=>{const o=z(e),n=Date.now(),i=[{id:`dl_${n}_0`,x:o.x,y:o.y},{id:`dl_${n}_1`,x:t.x,y:t.y}],a=e.name||e.id,c=t.name||t.id,u=`Link ${a} --- ${c}`,v=St();s.addPath({layerId:v,name:u,startPointId:e.id,endPointId:t.id,status:"0",type:"direct",geometry:{controlPoints:i,pathType:"line"},editorProps:{strokeColor:"#909399",strokeWidth:1.5,lineStyle:"dashed",arrowVisible:!1,label:`${a} --- ${c}`,labelVisible:!0}}),X.success("虚线链接已创建")},Q=e=>{Object.assign(L,{startLocation:null,currentPos:{x:0,y:0}}),ne.value=null;const t=e||T(m.value);t&&t.container&&(t.container().style.cursor="default");const o=T(m.value);o&&o.batchDraw()},tt=e=>{var n;const t=z(e),o=((n=L.startLocation)==null?void 0:n.id)===e.id;return{x:t.x,y:t.y,radius:o?8:6,fill:o?"#f7ba2a":"#909399",stroke:"#ffffff",strokeWidth:2,listening:!0,opacity:o?1:.8,hitStrokeWidth:20,perfectDrawEnabled:!1,zIndex:10}},ot=(e,t)=>{if(t.cancelBubble=!0,t.evt&&t.evt.stopPropagation(),d.value===l.DASHED_LINK){const o=t.target.getStage();if(o){L.startLocation=e;const n=z(e);L.currentPos={x:n.x,y:n.y},o.container().style.cursor="crosshair",s.currentTool!==l.DASHED_LINK&&s.setTool(l.DASHED_LINK)}}},nt=(e,t)=>{t.cancelBubble=!0,t.evt&&t.evt.stopPropagation()},st=(e,t)=>{t.cancelBubble=!0,t.evt&&t.evt.stopPropagation()},it=e=>{d.value===l.DASHED_LINK&&(ne.value=e.id,ae("pointer"))},rt=()=>{d.value===l.DASHED_LINK&&(L.startLocation||(ne.value=null),ae("default"))},at=e=>{const t=s.selection.selectedIds.has(e.id),o=[];return e.geometry.vertices.forEach(n=>{o.push(n.x,n.y)}),e.geometry.closed&&o.length>0&&o.push(e.geometry.vertices[0].x,e.geometry.vertices[0].y),{id:e.id,points:o,fill:t?"rgba(255, 77, 79, 0.3)":e.editorProps.fillColor||"rgba(24, 144, 255, 0.3)",fillOpacity:e.editorProps.fillOpacity||.3,stroke:t?"#ff4d4f":e.editorProps.strokeColor||"#1890ff",strokeWidth:e.editorProps.strokeWidth||2,closed:e.geometry.closed,listening:!0}},lt=e=>e===l.RULE_REGION?{stroke:"#ff7d00",fill:"rgba(255, 125, 0, 0.15)"}:{stroke:"#1890ff",fill:"rgba(24, 144, 255, 0.1)"},ct=e=>e===l.RULE_REGION?{strokeColor:"#ff7d00",strokeWidth:2,fillColor:"#ffedd9",fillOpacity:.35}:{strokeColor:"#1890ff",strokeWidth:2,fillColor:"#1890ff",fillOpacity:.3},ut=e=>{const t=e.target.getStage();if(!t)return;const o=t.getPointerPosition();if(!o)return;const n=(o.x-f.value.offsetX)/f.value.scale,i=(o.y-f.value.offsetY)/f.value.scale;if(he.value={x:n,y:i},d.value===l.PAN)Y.value=!0,ve.value={x:o.x,y:o.y},t.container().style.cursor="grabbing",e.evt.preventDefault();else if(d.value===l.POINT){const a=Xe(n,i),c=new Kt(a,u=>s.addPoint(u),u=>s.deletePoint(u));s.executeCommand(c),de.value=!0,requestAnimationFrame(()=>{setTimeout(()=>{s.currentTool===l.POINT&&s.setTool(l.SELECT)},50)}),e.evt.preventDefault(),e.evt.stopPropagation()}else if(d.value===l.LOCATION){const u=Date.now(),v=[{id:`loc_${u}_v1`,x:n-20,y:i-20},{id:`loc_${u}_v2`,x:n+20,y:i-20},{id:`loc_${u}_v3`,x:n+20,y:i+20},{id:`loc_${u}_v4`,x:n-20,y:i+20}],r=typeof s.generateLocationName=="function"?s.generateLocationName():`Location-${Date.now()}`;s.addLocation({layerId:le(),name:r,status:"0",geometry:{vertices:v,closed:!0},editorProps:{fillColor:"#ffffff",fillOpacity:1,strokeColor:"#000000",strokeWidth:2,labelVisible:!0}}),U.value={tool:l.LOCATION},requestAnimationFrame(()=>{setTimeout(()=>{s.currentTool===l.LOCATION&&s.setTool(l.SELECT)},50)}),e.evt.preventDefault(),e.evt.stopPropagation()}else if(d.value===l.RULE_REGION)H.value?E.value.push({x:n,y:i}):(H.value=!0,K.value=d.value,E.value=[{x:n,y:i}]);else if(d.value===l.DASHED_LINK)e.target===t&&Q(t);else if(d.value===l.PATH){const a=re(n,i);a?(p.startPoint=a,p.currentPos={x:a.x,y:a.y},p.pathType=s.pathConnectionType,t.container().style.cursor="crosshair"):Z(t)}else e.target===t&&p.startPoint&&Z(t)},ft=e=>{const t=e.target.getStage();if(!t)return;const o=t.getPointerPosition();if(!o)return;const n=(o.x-f.value.offsetX)/f.value.scale,i=(o.y-f.value.offsetY)/f.value.scale;if(he.value={x:n,y:i},d.value===l.PAN&&Y.value){const a=t.getPointerPosition();if(!a)return;const c=a.x-ve.value.x,u=a.y-ve.value.y;s.updateCanvasState({offsetX:f.value.offsetX+c,offsetY:f.value.offsetY+u}),ve.value={x:a.x,y:a.y}}if(H.value&&E.value.length>0&&(K.value===l.LOCATION||K.value===l.RULE_REGION)){const a=[];E.value.forEach(u=>{a.push(u.x,u.y)}),a.push(n,i),E.value.length>=2&&a.push(E.value[0].x,E.value[0].y);const c=lt(K.value);se.value={points:a,stroke:c.stroke,strokeWidth:2,fill:c.fill,closed:E.value.length>=2,dash:[5,5]}}if(d.value===l.PATH){const a=re(n,i);oe.value=(a==null?void 0:a.id)||null,p.startPoint&&(p.currentPos={x:n,y:i})}else if(d.value===l.DASHED_LINK){L.startLocation&&(L.currentPos={x:n,y:i});const a=re(n,i);oe.value=(a==null?void 0:a.id)||null}else oe.value=null,p.startPoint&&Z(),L.startLocation&&Q()},dt=e=>{var n;const t=(n=e.target)==null?void 0:n.getStage();if(de.value&&(de.value=!1,s.currentTool===l.POINT&&s.setTool(l.SELECT)),U.value){const i=U.value.tool;U.value=null,s.currentTool===i&&s.setTool(l.SELECT)}d.value===l.POINT&&!de.value&&setTimeout(()=>{s.currentTool===l.POINT&&s.setTool(l.SELECT)},100);const o=[l.LOCATION,l.PATH,l.DASHED_LINK,l.RULE_REGION];if(o.includes(d.value)&&!U.value&&setTimeout(()=>{o.includes(s.currentTool)&&s.setTool(l.SELECT)},100),d.value===l.PAN&&Y.value&&(Y.value=!1,t&&(t.container().style.cursor="default")),p.startPoint){const i=p.startPoint;let a=!1;if(d.value===l.PATH&&t&&e.evt.button===0){const c=t.getPointerPosition();if(c){const u=(c.x-f.value.offsetX)/f.value.scale,v=(c.y-f.value.offsetY)/f.value.scale,r=re(u,v);r&&r.id!==i.id?(Je(i,r),a=!0):r&&r.id===i.id?X.info("请选择不同的终点"):X.warning("请拖拽到另一个点以创建连线")}}Z(t),a&&(U.value={tool:l.PATH},requestAnimationFrame(()=>{setTimeout(()=>{s.currentTool===l.PATH&&s.setTool(l.SELECT)},50)}))}else d.value===l.PATH&&t&&e.evt.button===0&&Z(t);if(L.startLocation&&d.value===l.DASHED_LINK&&t&&e.evt.button===0){const i=L.startLocation,a=t.getPointerPosition();if(a){const c=(a.x-f.value.offsetX)/f.value.scale,u=(a.y-f.value.offsetY)/f.value.scale,v=re(c,u);v?(De(i,v),Q(t),U.value={tool:l.DASHED_LINK},requestAnimationFrame(()=>{setTimeout(()=>{s.currentTool===l.DASHED_LINK&&s.setTool(l.SELECT)},50)})):Q(t)}}e.evt.button===2&&(H.value&&(K.value===l.LOCATION||K.value===l.RULE_REGION)&&E.value.length>=3?vt():H.value&&me())},vt=()=>{if(E.value.length<3){X.warning("位置至少需要3个顶点");return}const e=K.value||l.LOCATION,t=e===l.RULE_REGION,o=ct(e),n=t?`规则区域_${Date.now()}`:typeof s.generateLocationName=="function"?s.generateLocationName():`Location-${Date.now()}`;s.addLocation({layerId:le(),name:n,status:"0",geometry:{vertices:E.value.map((i,a)=>({id:`v_${Date.now()}_${a}`,x:i.x,y:i.y})),closed:!0},editorProps:{fillColor:o.fillColor,fillOpacity:o.fillOpacity,strokeColor:o.strokeColor,strokeWidth:o.strokeWidth,labelVisible:!0}}),t&&(U.value={tool:l.RULE_REGION},requestAnimationFrame(()=>{setTimeout(()=>{s.currentTool===l.RULE_REGION&&s.setTool(l.SELECT)},50)})),H.value=!1,E.value=[],se.value=null,K.value=null,X.success(t?"规则区域绘制完成":"位置绘制完成")},me=()=>{H.value=!1,E.value=[],se.value=null,K.value=null,X.info("已取消绘制")},gt=e=>{e.evt.preventDefault(),e.evt.stopPropagation();const t=e.target.getStage();if(!t)return;const o=t.getPointerPosition();if(!o)return;const n=f.value.scale,i=1.1,c=e.evt.deltaY>0?n/i:n*i,u=Math.max(.1,Math.min(10,c));t.container().getBoundingClientRect();const v={x:o.x,y:o.y},r={x:(v.x-f.value.offsetX)/n,y:(v.y-f.value.offsetY)/n},y={x:v.x-r.x*u,y:v.y-r.y*u};s.updateCanvasState({scale:u,offsetX:y.x,offsetY:y.y})};let F=null;const yt=(e,t)=>{if(t.cancelBubble=!0,d.value===l.DASHED_LINK&&L.startLocation){De(L.startLocation,e),Q(t.target.getStage()),requestAnimationFrame(()=>{setTimeout(()=>{s.currentTool===l.DASHED_LINK&&s.setTool(l.SELECT)},50)});return}if(d.value!==l.PATH){if(F){clearTimeout(F),F=null;return}F=setTimeout(()=>{const o=t.evt.ctrlKey||t.evt.metaKey;s.selectElement(e.id,"point",o),F=null},Vt)}},ht=(e,t)=>{t.cancelBubble=!0,F&&(clearTimeout(F),F=null),d.value===l.SELECT&&w("point-double-click",e)},Pt=e=>{Y.value=!0},mt=(e,t)=>{const o=t.target,n=o.x(),i=o.y(),a=Ne({x:n,y:i},{snapToGrid:!0,gridSize:N.value,snapToPoint:!0,targetPoints:s.points.filter(c=>c.id!==e.id).map(c=>({x:c.x,y:c.y}))});o.x(a.x),o.y(a.y)},pt=e=>{Y.value=!1;const t=T($.value);if(t){const o=t.findOne(`#${e.id}`);if(o){const n=o.x(),i=o.y();s.updatePoint(e.id,{x:n,y:i})}}},Se=(e,t)=>{t.cancelBubble=!0;const o=t.evt.ctrlKey||t.evt.metaKey;s.selectElement(e.id,"path",o)},we=(e,t)=>{var n;if(t.cancelBubble=!0,d.value===l.DASHED_LINK){const i=z(e),a=(n=t.target.getStage())==null?void 0:n.getPointerPosition();if(a){const c=(a.x-f.value.offsetX)/f.value.scale,u=(a.y-f.value.offsetY)/f.value.scale;if(Math.hypot(c-i.x,u-i.y)<=10)return}return}const o=t.evt.ctrlKey||t.evt.metaKey;s.selectElement(e.id,"location",o)},xt=e=>{d.value===l.DASHED_LINK&&!Pe(e)?(ne.value=e.id,ae("pointer")):ae("move")},kt=(e,t)=>{if(d.value===l.DASHED_LINK){const o=t.target.getStage();if(o){const n=o.getPointerPosition();if(n){const i=(n.x-f.value.offsetX)/f.value.scale,a=(n.y-f.value.offsetY)/f.value.scale,c=z(e);if(Math.hypot(i-c.x,a-c.y)<=25)return}}L.startLocation||(ne.value=null)}ae("default")},Lt=(e,t,o)=>{const n=s.selection.selectedIds.has(e.id);return{id:`${e.id}-cp-${o}`,x:t.x,y:t.y,radius:n?6:4,fill:n?"#ff4d4f":"#52c41a",stroke:"#ffffff",strokeWidth:1,draggable:n&&d.value===l.SELECT,listening:!0,opacity:n?1:.7}},Ct=(e,t,o,n)=>{n.cancelBubble=!0,s.selectElement(e.id,"path",!1)},bt=(e,t,o)=>{Y.value=!0},Tt=(e,t,o,n)=>{const i=n.target,a=i.x(),c=i.y(),u=Ne({x:a,y:c},{snapToGrid:!0,gridSize:N.value,snapToPoint:!0,targetPoints:s.points.map(v=>({x:v.x,y:v.y}))});i.x(u.x),i.y(u.y)},Dt=(e,t,o)=>{Y.value=!1;const n=T(S.value);if(n){const i=n.findOne(`#${e.id}-cp-${o}`);if(i){const a=i.x(),c=i.y(),u=[...e.geometry.controlPoints];u[o]={...u[o],x:a,y:c},s.updatePath(e.id,{geometry:{...e.geometry,controlPoints:u}})}}},St=()=>{const e=s.layerGroups.find(t=>t.name==="Links");if(e){const t=s.layers.find(o=>o.layerGroupId===e.id);if(t)return t.id}return le()},le=e=>{if(s.activeLayerId&&s.layers.some(o=>o.id===s.activeLayerId))return s.activeLayerId;const t=s.layers.find(o=>o.name==="Default layer");if(t)return t.id;if(s.layers.length>0)return s.layers[0].id;throw new Error("没有可用的图层，请先在后端创建地图模型")},wt=e=>{te.value=e,J(()=>{const t=T(R.value);t&&t.draw()})},Et=e=>{N.value=Math.max(5,Math.min(100,e)),J(()=>{const t=T(R.value);t&&t.draw()})},ge=x(!0),Ee=x(!0),_t=e=>{ge.value=e,J(()=>{[$.value,S.value,B.value].forEach(t=>{const o=T(t);o&&o.batchDraw()})})},It=e=>{Ee.value=e,J(()=>{const t=T(B.value);t&&t.batchDraw()})};pe(()=>[f.value.scale,f.value.offsetX,f.value.offsetY,f.value.width,f.value.height,te.value,N.value],()=>{J(()=>{const e=T(R.value);e&&e.batchDraw()})},{deep:!0,immediate:!0}),pe(()=>ke.value.length,()=>{J(()=>{const e=T(R.value);e&&e.batchDraw()})}),pe(d,e=>{e!==l.PATH&&Z(),e!==l.DASHED_LINK&&Q(),![l.LOCATION,l.RULE_REGION].includes(e)&&H.value&&me()}),P({setGridVisible:wt,setGridSize:Et,setLabelsVisible:_t,setBlocksVisible:It,gridSize:N,showGrid:te,showLabels:ge,showBlocks:Ee,getMousePosition:()=>he.value});const _e=e=>{e.key==="Escape"&&((d.value===l.LOCATION||d.value===l.RULE_REGION)&&H.value?me():d.value===l.PATH&&p.startPoint?(Z(),X.info("已取消连线起点")):d.value===l.DASHED_LINK&&L.startLocation&&(Q(),X.info("已取消虚线起点")))};let ce=null;return Ot(()=>{if(J(()=>{if(b.value){const e=b.value.clientWidth||1920,t=b.value.clientHeight||1080;s.updateCanvasState({width:e,height:t}),ce=new ResizeObserver(()=>{if(b.value){const o=b.value.clientWidth||1920,n=b.value.clientHeight||1080;s.updateCanvasState({width:o,height:n})}}),ce.observe(b.value),setTimeout(()=>{const o=T(R.value);o&&(o.batchDraw(),setTimeout(()=>{o.batchDraw()},50))},100)}}),!s.activeLayerId||!s.layers.some(e=>e.id===s.activeLayerId)){const e=s.layers.find(t=>t.name==="Default layer")||s.layers[0];e&&s.setActiveLayer(e.id)}window.addEventListener("keydown",_e)}),Rt(()=>{window.removeEventListener("keydown",_e),ce&&(ce.disconnect(),ce=null)}),(e,t)=>{const o=ee("v-rect"),n=ee("v-layer"),i=ee("v-line"),a=ee("v-circle"),c=ee("v-text"),u=ee("v-arrow"),v=ee("v-stage");return h(),W("div",{class:"map-canvas-container",ref_key:"containerRef",ref:b},[I(v,{ref_key:"stageRef",ref:m,config:Me.value,onMousedown:ut,onMousemove:ft,onMouseup:dt,onWheel:gt,onContextmenu:t[0]||(t[0]=Ae(()=>{},["prevent"]))},{default:j(()=>[I(n,{ref_key:"backgroundLayerRef",ref:A,config:{name:"background",listening:!1}},{default:j(()=>[I(o,{config:Re.value},null,8,["config"])]),_:1},512),I(n,{config:{name:"center-marker",listening:!1}},{default:j(()=>[te.value?(h(),D(i,{key:0,config:xe.value.horizontal},null,8,["config"])):O("",!0),te.value?(h(),D(i,{key:1,config:xe.value.vertical},null,8,["config"])):O("",!0),I(a,{config:Oe.value},null,8,["config"])]),_:1}),I(n,{ref_key:"gridLayerRef",ref:R,config:{name:"grid",listening:!1,perfectDrawEnabled:!1,clearBeforeDraw:!0}},{default:j(()=>[(h(!0),W(G,null,ue(ke.value,(r,y)=>(h(),D(i,{key:`grid-${y}`,config:r},null,8,["config"]))),128))]),_:1},512),I(n,{ref_key:"pointLayerRef",ref:$,config:{name:"point"}},{default:j(()=>[(h(!0),W(G,null,ue(Le.value,r=>(h(),W(G,{key:r.id},[I(a,{config:Ve(r),onClick:y=>yt(r,y),onDblclick:y=>ht(r,y),onDragstart:y=>Pt(r),onDragmove:y=>mt(r,y),onDragend:y=>pt(r)},null,8,["config","onClick","onDblclick","onDragstart","onDragmove","onDragend"]),He(r)?(h(),D(c,{key:`${r.id}-glyph`,config:ze(r)},null,8,["config"])):O("",!0),Ke(r)?(h(),D(c,{key:`${r.id}-label`,config:Ye(r)},null,8,["config"])):O("",!0)],64))),128))]),_:1},512),I(n,{ref_key:"pathLayerRef",ref:S,config:{name:"path"}},{default:j(()=>[(h(!0),W(G,null,ue(We.value,r=>(h(),W(G,{key:r.id},[I(i,{config:Ue(r),onClick:y=>Se(r,y)},null,8,["config","onClick"]),qe(r)?(h(),D(u,{key:0,config:Fe(r),onClick:y=>Se(r,y)},null,8,["config","onClick"])):O("",!0),(h(!0),W(G,null,ue(r.geometry.controlPoints,(y,M)=>(h(),D(a,{key:`${r.id}-cp-${M}`,config:Lt(r,y,M),onClick:Ae(C=>Ct(r,y,M,C),["stop"]),onDragstart:C=>bt(r,y,M),onDragmove:C=>Tt(r,y,M,C),onDragend:C=>Dt(r,y,M)},null,8,["config","onClick","onDragstart","onDragmove","onDragend"]))),128))],64))),128))]),_:1},512),I(n,{ref_key:"locationLayerRef",ref:B,config:{name:"location"}},{default:j(()=>[(h(!0),W(G,null,ue($e.value,r=>{var y,M;return h(),W(G,{key:r.id},[Pe(r)?(h(),D(i,{key:1,config:at(r),onClick:C=>we(r,C)},null,8,["config","onClick"])):(h(),D(o,{key:0,config:je(r),onClick:C=>we(r,C),onMouseover:C=>xt(r),onMouseout:C=>kt(r,C)},null,8,["config","onClick","onMouseover","onMouseout"])),(y=r.editorProps)!=null&&y.label?(h(),D(c,{key:`${r.id}-symbol`,config:Ze(r)},null,8,["config"])):O("",!0),Qe(r)?(h(),D(c,{key:`${r.id}-label`,config:et(r)},null,8,["config"])):O("",!0),d.value===Wt(l).DASHED_LINK&&(ne.value===r.id||((M=L.startLocation)==null?void 0:M.id)===r.id)?(h(),D(a,{key:`${r.id}-center`,config:tt(r),onClick:C=>st(r,C),onMousedown:C=>ot(r,C),onMouseup:C=>nt(r,C),onMouseover:C=>it(r),onMouseout:rt},null,8,["config","onClick","onMousedown","onMouseup","onMouseover"])):O("",!0)],64)}),128))]),_:1},512),I(n,{ref_key:"tempLayerRef",ref:V,config:{name:"temp"}},{default:j(()=>[se.value?(h(),D(i,{key:0,config:se.value},null,8,["config"])):O("",!0),ie.value&&p.startPoint?(h(),W(G,{key:1},[(h(),D(i,{key:`preview-line-${p.startPoint.id}`,config:ie.value.line},null,8,["config"])),(h(),D(u,{key:`preview-arrow-${p.startPoint.id}`,config:ie.value.arrow},null,8,["config"])),(h(),D(a,{key:`preview-start-${p.startPoint.id}`,config:ie.value.startMarker},null,8,["config"])),(h(),D(a,{key:`preview-end-${p.startPoint.id}`,config:ie.value.endMarker},null,8,["config"]))],64)):O("",!0),Te.value&&L.startLocation?(h(),D(i,{key:`dashed-link-preview-${L.startLocation.id}`,config:Te.value},null,8,["config"])):O("",!0)]),_:1},512)]),_:1},8,["config"])],512)}}}),jt=$t(Ut,[["__scopeId","data-v-3868442d"]]);export{jt as default};
