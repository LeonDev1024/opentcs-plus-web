import{b1 as ue,r as p,ag as $,N as D}from"./index-B9WM9B43.js";import{l as ce,s as de}from"./index-BJgmA4Qg.js";var Y=(s=>(s.SELECT="select",s.POINT="point",s.PATH="path",s.LOCATION="location",s.PAN="pan",s.ZOOM="zoom",s.DASHED_LINK="dashedLink",s.RULE_REGION="ruleRegion",s))(Y||{});class fe{constructor(){this.undoStack=[],this.redoStack=[],this.maxHistorySize=50}execute(c){c.execute(),this.undoStack.push(c),this.undoStack.length>this.maxHistorySize&&this.undoStack.shift(),this.redoStack=[]}undo(){if(this.undoStack.length===0)return!1;const c=this.undoStack.pop();return c.undo(),this.redoStack.push(c),!0}redo(){if(this.redoStack.length===0)return!1;const c=this.redoStack.pop();return c.redo(),this.undoStack.push(c),!0}clear(){this.undoStack=[],this.redoStack=[]}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoStackSize(){return this.undoStack.length}getRedoStackSize(){return this.redoStack.length}}class ke{constructor(c,k,N,w="添加点"){this.pointData=c,this.addCallback=k,this.removeCallback=N,this.description=w,this.createdPoint=null}execute(){const c=this.createdPoint||this.pointData;this.createdPoint=this.addCallback(c)}undo(){this.createdPoint&&this.removeCallback(this.createdPoint.id)}redo(){this.createdPoint?this.createdPoint=this.addCallback({...this.createdPoint}):this.execute()}}const Ne=ue("mapEditor",()=>{const s=p(null),c=p(null),k=p(Y.SELECT),N=p("Halt point"),w=p(0),x=p(0),G=p("direct"),d=$({scale:1,offsetX:0,offsetY:0,width:1920,height:1080}),v=p([]),i=p([]),g=p(null),h=p([]),y=p([]),m=p([]),f=$({selectedIds:new Set,selectedType:null}),L=new fe,E=p(!1),u=p(!1),M=/^Point-(\d+)$/i,R=e=>`Point-${e.toString().padStart(4,"0")}`,C=e=>{if(!e)return;const a=e.match(M);if(a){const t=parseInt(a[1],10);Number.isNaN(t)||(w.value=Math.max(w.value,t))}},V=()=>{w.value=0,h.value.forEach(e=>C(e.name))},U=()=>(w.value+=1,R(w.value)),H=/^Location-(\d+)$/i,z=e=>`Location-${e.toString().padStart(4,"0")}`,O=e=>{if(!e)return;const a=e.match(H);if(a){const t=parseInt(a[1],10);Number.isNaN(t)||(x.value=Math.max(x.value,t))}},F=()=>{x.value=0,m.value.forEach(e=>O(e.name))},B=()=>(x.value+=1,z(x.value)),j=D(()=>{const e=[];return f.selectedType==="point"?f.selectedIds.forEach(a=>{const t=h.value.find(n=>n.id===a);t&&e.push(t)}):f.selectedType==="path"?f.selectedIds.forEach(a=>{const t=y.value.find(n=>n.id===a);t&&e.push(t)}):f.selectedType==="location"&&f.selectedIds.forEach(a=>{const t=m.value.find(n=>n.id===a);t&&e.push(t)}),e}),K=D(()=>L.canUndo()),W=D(()=>L.canRedo()),Z=async e=>{var a,t,n,S,X;try{E.value=!0,c.value=e;let l;try{const r=await ce(e),o=r.data||r,I=o.data||o;if(I&&(I.name||I.visualLayout)){const P=I.visualLayout||{};l={mapInfo:{id:I.mapId||e,name:I.name||"新地图",mapVersion:I.modelVersion||"1.0",description:I.description||"",width:1920,height:1080,scale:1,offsetX:0,offsetY:0,scaleX:parseFloat(P.scaleX)||50,scaleY:parseFloat(P.scaleY)||50},layerGroups:P.layerGroups||[],layers:P.layers||[],elements:{points:I.points||[],paths:I.paths||[],locations:I.locations||[]},metadata:{createdAt:I.createTime||new Date().toISOString(),updatedAt:I.updateTime||new Date().toISOString()},visualLayout:P}}else if(o.mapInfo)l={mapInfo:{id:o.mapInfo.id||e,name:o.mapInfo.name||"新地图",mapVersion:o.mapInfo.modelVersion||"1.0",description:o.mapInfo.description||"",width:parseFloat(o.mapInfo.layoutWidth)||1920,height:parseFloat(o.mapInfo.layoutHeight)||1080,scale:parseFloat(o.mapInfo.scale)||1,offsetX:0,offsetY:0,scaleX:50,scaleY:50},layerGroups:o.layerGroups||[],layers:o.layers||[],elements:{points:((a=o.elements)==null?void 0:a.points)||o.points||[],paths:((t=o.elements)==null?void 0:t.paths)||o.paths||[],locations:((n=o.elements)==null?void 0:n.locations)||o.locations||[]},metadata:{createdAt:o.mapInfo.createTime||new Date().toISOString(),updatedAt:o.mapInfo.updateTime||new Date().toISOString()}};else throw new Error("地图数据不存在，请先在后端创建地图模型")}catch(r){throw((S=r==null?void 0:r.response)==null?void 0:S.status)===404||(X=r==null?void 0:r.message)!=null&&X.includes("不存在")?new Error("地图数据不存在，请先在后端创建地图模型"):r}if(console.log("地图数据：",l.mapInfo),!l||!l.mapInfo)throw new Error("地图数据格式错误");if(s.value=l,v.value=l.layerGroups||[],i.value=l.layers||[],h.value=(l.elements.points||[]).map(r=>{var o;return{...r,editorProps:{...r.editorProps,labelVisible:((o=r.editorProps)==null?void 0:o.labelVisible)!==!1}}}),y.value=l.elements.paths||[],m.value=(l.elements.locations||[]).map(r=>{var o;return{...r,editorProps:{...r.editorProps,labelVisible:((o=r.editorProps)==null?void 0:o.labelVisible)!==!1}}}),V(),F(),l.mapInfo&&(d.width=l.mapInfo.width||1920,d.height=l.mapInfo.height||1080,d.scale=l.mapInfo.scale||1,d.offsetX=l.mapInfo.offsetX||0,d.offsetY=l.mapInfo.offsetY||0,l.mapInfo.scaleX===void 0&&(l.mapInfo.scaleX=50),l.mapInfo.scaleY===void 0&&(l.mapInfo.scaleY=50)),!g.value||!i.value.some(r=>r.id===g.value)){const r=i.value.find(o=>o.name==="Default layer")||i.value[0];g.value=r?r.id:null}return b(),L.clear(),u.value=!1,l}catch(l){throw console.error("加载地图失败:",l),l}finally{E.value=!1}},q=async()=>{if(!c.value)throw new Error("没有可保存的地图模型ID");try{if(E.value=!0,!s.value)throw new Error("地图数据不存在，请先加载地图数据");return s.value.layerGroups=v.value,s.value.layers=i.value,s.value.elements.points=h.value,s.value.elements.paths=y.value,s.value.elements.locations=m.value,s.value.mapInfo.scale=d.scale,s.value.mapInfo.offsetX=d.offsetX,s.value.mapInfo.offsetY=d.offsetY,s.value.mapInfo.width=d.width,s.value.mapInfo.height=d.height,s.value.metadata.updatedAt=new Date().toISOString(),s.value.mapInfo.name||(s.value.mapInfo.name=`地图_${c.value}`),await de(c.value,s.value),u.value=!1,s.value}catch(e){throw console.error("保存地图失败:",e),e}finally{E.value=!1}},J=e=>{k.value=e,b()},Q=e=>{N.value=e},ee=e=>{G.value=e},te=e=>{Object.assign(d,e),u.value=!0},ae=e=>{const a={...e,id:e.id||`point_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};h.value.push(a);const t=i.value.find(n=>n.id===e.layerId);return t&&t.elementIds.push(a.id),C(a.name),u.value=!0,a},ne=(e,a)=>{const t=h.value.findIndex(n=>n.id===e);t!==-1&&(h.value[t]={...h.value[t],...a},u.value=!0)},_=e=>{const a=h.value.findIndex(t=>t.id===e);a!==-1&&(h.value.splice(a,1),i.value.forEach(t=>{const n=t.elementIds.indexOf(e);n!==-1&&t.elementIds.splice(n,1)}),f.selectedIds.delete(e),u.value=!0)},se=e=>{const a={...e,id:`path_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};y.value.push(a);const t=i.value.find(n=>n.id===e.layerId);return t&&t.elementIds.push(a.id),u.value=!0,a},oe=(e,a)=>{const t=y.value.findIndex(n=>n.id===e);t!==-1&&(y.value[t]={...y.value[t],...a},u.value=!0)},T=e=>{const a=y.value.findIndex(t=>t.id===e);a!==-1&&(y.value.splice(a,1),i.value.forEach(t=>{const n=t.elementIds.indexOf(e);n!==-1&&t.elementIds.splice(n,1)}),f.selectedIds.delete(e),u.value=!0)},le=e=>{const a={...e,id:`location_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};m.value.push(a);const t=i.value.find(n=>n.id===e.layerId);return t&&t.elementIds.push(a.id),O(a.name),u.value=!0,a},ie=(e,a)=>{const t=m.value.findIndex(n=>n.id===e);t!==-1&&(m.value[t]={...m.value[t],...a},u.value=!0)},A=e=>{const a=m.value.findIndex(t=>t.id===e);a!==-1&&(m.value.splice(a,1),i.value.forEach(t=>{const n=t.elementIds.indexOf(e);n!==-1&&t.elementIds.splice(n,1)}),f.selectedIds.delete(e),u.value=!0)},re=(e,a,t=!1)=>{t||f.selectedIds.clear(),f.selectedIds.add(e),f.selectedType=a},b=()=>{f.selectedIds.clear(),f.selectedType=null};return{mapData:s,currentMapModelId:c,currentTool:k,pointType:N,pathConnectionType:G,canvasState:d,layerGroups:v,layers:i,activeLayerId:g,points:h,paths:y,locations:m,selection:f,loading:E,isDirty:u,selectedElements:j,canUndo:K,canRedo:W,loadMap:Z,saveMap:q,setTool:J,setPointType:Q,setPathConnectionType:ee,generatePointName:U,generateLocationName:B,updateCanvasState:te,addPoint:ae,updatePoint:ne,deletePoint:_,addPath:se,updatePath:oe,deletePath:T,addLocation:le,updateLocation:ie,deleteLocation:A,selectElement:re,clearSelection:b,addLayer:e=>{let a=e.layerGroupId;if(!a){const n=v.value.find(S=>S.name==="Default layer group");n?a=n.id:v.value.length>0&&(a=v.value[0].id)}const t={...e,id:`layer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,layerGroupId:a,elementIds:e.elementIds||[]};return i.value.push(t),u.value=!0,t},updateLayer:(e,a)=>{const t=i.value.findIndex(n=>n.id===e);t!==-1&&(i.value[t]={...i.value[t],...a},u.value=!0)},deleteLayer:e=>{const a=i.value.findIndex(t=>t.id===e);if(a!==-1){if(i.value[a].elementIds.forEach(n=>{h.value.find(S=>S.id===n)?_(n):y.value.find(S=>S.id===n)?T(n):m.value.find(S=>S.id===n)&&A(n)}),i.value.splice(a,1),g.value===e){const n=i.value.find(S=>S.name==="Default layer")||i.value[0];g.value=n?n.id:null}u.value=!0}},setActiveLayer:e=>{e&&!i.value.find(a=>a.id===e)||g.value!==e&&(g.value=e,u.value=!0)},addLayerGroup:e=>{const a={...e,id:`layer_group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};return v.value.push(a),u.value=!0,a},updateLayerGroup:(e,a)=>{const t=v.value.findIndex(n=>n.id===e);t!==-1&&(v.value[t]={...v.value[t],...a},u.value=!0)},deleteLayerGroup:e=>{const a=v.value.findIndex(t=>t.id===e);if(a!==-1){if(i.value.filter(n=>n.layerGroupId===e).length>0)throw new Error("无法删除图层组，仍有图层在使用该图层组");v.value.splice(a,1),u.value=!0}},undo:()=>{L.undo()},redo:()=>{L.redo()},executeCommand:e=>{L.execute(e),u.value=!0},reset:()=>{s.value=null,c.value=null,v.value=[],i.value=[],h.value=[],y.value=[],m.value=[],g.value=null,b(),L.clear(),d.scale=1,d.offsetX=0,d.offsetY=0,u.value=!1,w.value=0,x.value=0}}});export{ke as A,Y as T,Ne as u};
