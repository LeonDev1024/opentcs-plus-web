import{d as Ve,u as Oe,a as Be,r as p,N as w,k as te,b as Fe,E as y,n as oe,Z as ae,O as $e,c as le,o as T,p as n,m as e,G as M,t as $,x as Ge,y as C,e as d,q as a,R as Ke,H as Ue,$ as We,a0 as Ze,Q as Xe,_ as L,a1 as qe,I as se,S as Ye,a2 as Qe,a3 as je,a4 as z,F as Je,A as et,a5 as ne,w as G,a6 as K,a7 as tt,a8 as ot,M as at}from"./index-B9WM9B43.js";import lt from"./MapCanvas-CU718wmC.js";import st from"./LayerPanel-BDgbMI1E.js";import nt from"./ComponentsPanel-C-OYe6ks.js";import it from"./PointEditDialog-B41o9-gh.js";import{u as ct,T as r}from"./mapEditor-C3208Y0J.js";import ie from"./PathTypeIcon-CB2I1RP5.js";import rt from"./LocationTypeIcon-BLKEo_0I.js";import"./el-tab-pane-BQbBlK-W.js";import"./el-table-column-CfNB-tiT.js";import"./_initCloneObject-CtNQcUp4.js";import"./el-checkbox-CIZQMxKL.js";import"./el-radio-Cy5OMmSA.js";import"./el-tree-FBGJd7y4.js";import"./PointDetailDialog-BfXcF0ul.js";/* empty css                  */import"./el-descriptions-item-BMqIgY0I.js";import"./el-form-item-C52vg3Rn.js";import"./_baseClone-DI-sfL8c.js";import"./el-input-number-CWw6lCGD.js";import"./index-C6vhygJv.js";import"./index-BJgmA4Qg.js";const dt={class:"map-editor"},ut={class:"menu-bar"},pt={class:"menu-left"},mt={class:"editor-title"},vt={class:"menu-right"},ft={class:"toolbar"},_t={class:"toolbar-left"},yt={class:"point-tool-wrapper toolbar-tool toolbar-tool-point"},ht={class:"point-type-option"},bt={class:"point-type-option"},gt={class:"path-tool-wrapper toolbar-tool toolbar-tool-path"},wt={class:"zoom-level"},Ct={class:"toolbar-right"},kt={class:"editor-content"},Pt={class:"panel-container"},Et={class:"panel-content"},Tt={class:"panel-container"},Lt={class:"panel-content"},zt={class:"canvas-area"},Dt={class:"canvas-wrapper"},St={class:"status-bar"},It={class:"status-right"},Mt={class:"coordinates"},ce=200,re=600,Nt=280,de="map-editor-left-panel-width",At=Ve({__name:"MapEditor",setup(xt){const ue=Oe(),pe=Be(),l=ct(),f=p(),D=p(!0),h=p(!0),S=p(!0),N=p({x:0,y:0}),A=p(!1),U=p(null),b=p(!1),g=p(!1),I=p(!1),k=p(Nt),P=p(!1),W=p(0),Z=p(0),m=w(()=>l.currentTool),me=w(()=>l.canUndo),ve=w(()=>l.canRedo),fe=w(()=>l.loading),_e=w(()=>l.isDirty),ye=w(()=>l.canvasState),he=[{value:"direct",label:"直接连线"},{value:"orthogonal",label:"直角连线"},{value:"curve",label:"圆角连线"}],be={direct:"直接连线",orthogonal:"直角连线",curve:"圆角连线"},_=t=>{l.setTool(t);const o={[r.SELECT]:"选择工具",[r.PAN]:"平移工具",[r.POINT]:"绘制点",[r.PATH]:"绘制路径",[r.LOCATION]:"绘制位置",[r.ZOOM]:"缩放工具",[r.DASHED_LINK]:"虚线链接",[r.RULE_REGION]:"规则区域"};y.success(`已切换到${o[t]}`)},ge=t=>t==="Park point"?"park-point":"halt-point",we=t=>{l.setPointType(t);const o={"Halt point":"临时停车","Park point":"长时间停车"};y.success(`点位类型已切换为：${o[t]}`)},Ce=t=>{l.setPathConnectionType(t),y.success(`连线类型已切换为：${be[t]}`)},ke=t=>{t&&m.value!==r.POINT&&_(r.POINT)},Pe=t=>{t&&m.value!==r.PATH&&_(r.PATH)},x=()=>{const t=document.querySelector(".app-wrapper")||document.body;t&&(b.value?t.classList.add("map-editor-header-collapsed"):t.classList.remove("map-editor-header-collapsed"))},Ee=()=>{b.value=!b.value,x()},Te=()=>{g.value=!g.value},Le=()=>{I.value=!I.value};te(b,()=>{oe(()=>x())});const X=()=>{l.undo()},q=()=>{l.redo()},ze=()=>{const t=l.canvasState.scale;l.updateCanvasState({scale:Math.min(t*1.2,10)})},De=()=>{const t=l.canvasState.scale;l.updateCanvasState({scale:Math.max(t/1.2,.1)})},Se=()=>{l.updateCanvasState({scale:1,offsetX:0,offsetY:0})},Ie=()=>{D.value=!D.value,f.value&&f.value.setGridVisible(D.value)},Me=()=>{var t,o;h.value=!h.value,f.value&&((o=(t=f.value).setLabelsVisible)==null||o.call(t,h.value)),l.points.forEach(c=>{l.updatePoint(c.id,{editorProps:{...c.editorProps,labelVisible:h.value}})}),l.paths.forEach(c=>{l.updatePath(c.id,{editorProps:{...c.editorProps,labelVisible:h.value}})}),l.locations.forEach(c=>{l.updateLocation(c.id,{editorProps:{...c.editorProps,labelVisible:h.value}})})},Ne=()=>{var t,o;S.value=!S.value,f.value&&((o=(t=f.value).setBlocksVisible)==null||o.call(t,S.value))};te(()=>f.value,t=>{if(t){const o=()=>{var s;try{const v=(s=t.getMousePosition)==null?void 0:s.call(t);v&&(N.value=v)}catch{}};let c;const i=()=>{o(),c=requestAnimationFrame(i)};c=requestAnimationFrame(i),ae(()=>{c&&cancelAnimationFrame(c)})}},{immediate:!0});const Ae=t=>{P.value=!0,W.value=t.clientX,Z.value=k.value,document.addEventListener("mousemove",R),document.addEventListener("mouseup",H),document.body.style.cursor="col-resize",document.body.style.userSelect="none",t.preventDefault()},R=t=>{if(!P.value)return;const o=t.clientX-W.value,c=Z.value+o;k.value=Math.max(ce,Math.min(re,c))},H=()=>{P.value&&(P.value=!1,document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",H),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem(de,k.value.toString()))};Fe(async()=>{var c,i;const t=localStorage.getItem(de);if(t){const s=parseInt(t,10);s>=ce&&s<=re&&(k.value=s)}const o=ue.query.id;if(o)try{await l.loadMap(o),y.success("地图加载成功")}catch(s){const v=((i=(c=s==null?void 0:s.response)==null?void 0:c.data)==null?void 0:i.msg)||(s==null?void 0:s.message)||"加载失败";y.error("加载地图失败："+v),console.error("加载错误详情:",s)}else{y.warning("未指定地图ID，将创建新地图");const s="new_"+Date.now();try{await l.loadMap(s)}catch(v){console.error("创建新地图失败:",v)}}window.addEventListener("keydown",Y),x(),oe(()=>{f.value&&f.value.setGridSize(20)})});const V=async()=>{var t,o;try{await l.saveMap(),y.success("保存成功")}catch(c){const i=((o=(t=c==null?void 0:c.response)==null?void 0:t.data)==null?void 0:o.msg)||(c==null?void 0:c.message)||"保存失败";y.error("保存失败："+i),console.error("保存错误详情:",c)}},xe=async()=>{if(_e.value)try{await ot.confirm("有未保存的更改，是否保存？","提示",{confirmButtonText:"保存",cancelButtonText:"不保存",distinguishCancelAndClose:!0,type:"warning"}),await V()}catch{}pe.back()},Re=t=>{U.value=t,A.value=!0},He=()=>{},Y=t=>{t.ctrlKey&&t.key==="z"&&!t.shiftKey&&(t.preventDefault(),X()),t.ctrlKey&&t.shiftKey&&t.key==="Z"&&(t.preventDefault(),q()),t.ctrlKey&&t.key==="s"&&(t.preventDefault(),V())};return ae(()=>{window.removeEventListener("keydown",Y),document.removeEventListener("mousemove",R),document.removeEventListener("mouseup",H),document.body.style.cursor="",document.body.style.userSelect="";const t=document.querySelector(".app-wrapper");t==null||t.classList.remove("map-editor-header-collapsed"),l.reset()}),(t,o)=>{var J,ee;const c=Ke,i=Ue,s=We,v=Ze,O=Xe,B=$e("ArrowDown"),E=Ye,F=je,Q=Qe,j=qe;return T(),le("div",dt,[n("div",ut,[n("div",pt,[n("span",mt,[M(" 地图编辑器 - "+C(((ee=(J=d(l).mapData)==null?void 0:J.mapInfo)==null?void 0:ee.name)||"未命名地图")+" ",1),d(l).mapData?(T(),$(c,{key:0,size:"small",type:"info",style:{"margin-left":"8px"}},{default:a(()=>[M(" v"+C(d(l).mapData.mapInfo.mapVersion||"1.0"),1)]),_:1})):Ge("",!0)])]),n("div",vt,[e(i,{type:"success",size:"small",icon:"Document",onClick:V,loading:fe.value},{default:a(()=>o[10]||(o[10]=[M(" 保存 ")])),_:1},8,["loading"]),e(i,{size:"small",icon:"Close",onClick:xe},{default:a(()=>o[11]||(o[11]=[M("关闭")])),_:1})])]),n("div",ft,[n("div",_t,[e(v,null,{default:a(()=>[e(s,{content:"选择工具","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:m.value==="select"?"primary":"default",size:"small",icon:"Pointer",onClick:o[0]||(o[0]=u=>_(d(r).SELECT))},null,8,["type"])]),_:1}),e(s,{content:"平移工具","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:m.value==="pan"?"primary":"default",size:"small",icon:"Rank",onClick:o[1]||(o[1]=u=>_(d(r).PAN))},null,8,["type"])]),_:1})]),_:1}),e(O,{direction:"vertical"}),e(v,{class:"creation-tool-group"},{default:a(()=>[n("div",yt,[e(s,{content:"绘制点","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:m.value==="point"?"primary":"default",size:"small",onClick:o[2]||(o[2]=u=>_(d(r).POINT)),class:"point-tool-main"},{icon:a(()=>[e(L,{"icon-class":ge(d(l).pointType),class:"point-type-svg-icon"},null,8,["icon-class"])]),_:1},8,["type"])]),_:1}),e(j,{onCommand:we,trigger:"click",placement:"bottom",onVisibleChange:ke},{dropdown:a(()=>[e(Q,null,{default:a(()=>[e(F,{command:"Halt point",class:z({"is-selected":d(l).pointType==="Halt point"})},{default:a(()=>[n("div",ht,[e(L,{"icon-class":"halt-point",class:"point-type-svg-icon"}),o[12]||(o[12]=n("span",null,"临时停车 (Halt point)",-1))])]),_:1},8,["class"]),e(F,{command:"Park point",class:z({"is-selected":d(l).pointType==="Park point"})},{default:a(()=>[n("div",bt,[e(L,{"icon-class":"park-point",class:"point-type-svg-icon"}),o[13]||(o[13]=n("span",null,"长时间停车 (Park point)",-1))])]),_:1},8,["class"])]),_:1})]),default:a(()=>[e(i,{type:m.value==="point"?"primary":"default",size:"small",class:"point-tool-dropdown",onClick:o[3]||(o[3]=se(()=>{},["stop"]))},{default:a(()=>[e(E,null,{default:a(()=>[e(B)]),_:1})]),_:1},8,["type"])]),_:1})]),n("div",gt,[e(s,{content:"创建连线","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:m.value==="path"?"primary":"default",size:"small",onClick:o[4]||(o[4]=u=>_(d(r).PATH)),class:"path-tool-main"},{icon:a(()=>[e(ie,{type:d(l).pathConnectionType,active:m.value==="path"},null,8,["type","active"])]),_:1},8,["type"])]),_:1}),e(j,{onCommand:Ce,trigger:"click",placement:"bottom",onVisibleChange:Pe},{dropdown:a(()=>[e(Q,null,{default:a(()=>[(T(),le(Je,null,et(he,u=>e(F,{key:u.value,command:u.value,class:z({"is-selected":d(l).pathConnectionType===u.value})},{default:a(()=>[e(ie,{class:"path-type-icon",type:u.value,active:d(l).pathConnectionType===u.value},null,8,["type","active"]),n("span",null,C(u.label),1)]),_:2},1032,["command","class"])),64))]),_:1})]),default:a(()=>[e(i,{type:m.value==="path"?"primary":"default",size:"small",class:"path-tool-dropdown",onClick:o[5]||(o[5]=se(()=>{},["stop"]))},{default:a(()=>[e(E,null,{default:a(()=>[e(B)]),_:1})]),_:1},8,["type"])]),_:1})]),e(s,{content:"绘制位置","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{class:"toolbar-tool toolbar-tool-location",type:m.value==="location"?"primary":"default",size:"small",onClick:o[6]||(o[6]=u=>_(d(r).LOCATION))},{icon:a(()=>[e(rt,{active:m.value==="location",symbol:"L"},null,8,["active"])]),_:1},8,["type"])]),_:1}),e(s,{content:"虚线路径（点↔业务位置）","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{class:"toolbar-tool toolbar-tool-dashed",type:m.value==="dashedLink"?"primary":"default",size:"small",onClick:o[7]||(o[7]=u=>_(d(r).DASHED_LINK))},{icon:a(()=>[e(L,{"icon-class":"dashed-link",style:{"font-size":"16px"}})]),_:1},8,["type"])]),_:1}),e(s,{content:"规则区域","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{class:"toolbar-tool toolbar-tool-rule",type:m.value==="ruleRegion"?"primary":"default",size:"small",onClick:o[8]||(o[8]=u=>_(d(r).RULE_REGION))},{icon:a(()=>[e(L,{"icon-class":"rule-region",style:{"font-size":"18px"}})]),_:1},8,["type"])]),_:1})]),_:1}),e(O,{direction:"vertical"}),e(v,null,{default:a(()=>[e(s,{content:"撤销 (Ctrl+Z)","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{size:"small",icon:"RefreshLeft",disabled:!me.value,onClick:X},null,8,["disabled"])]),_:1}),e(s,{content:"重做 (Ctrl+Shift+Z)","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{size:"small",icon:"RefreshRight",disabled:!ve.value,onClick:q},null,8,["disabled"])]),_:1})]),_:1}),e(O,{direction:"vertical"}),n("span",wt,C(Math.round(ye.value.scale*100))+"%",1),e(v,{size:"small"},{default:a(()=>[e(s,{content:"放大","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{icon:"ZoomIn",onClick:ze,circle:!0})]),_:1}),e(s,{content:"缩小","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{icon:"ZoomOut",onClick:De,circle:!0})]),_:1}),e(s,{content:"重置缩放","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{icon:"FullScreen",onClick:Se,circle:!0})]),_:1})]),_:1}),e(s,{content:"显示/隐藏网格","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:D.value?"primary":"default",size:"small",icon:"Grid",onClick:Ie,circle:!0},null,8,["type"])]),_:1}),e(s,{content:"显示/隐藏标签","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:h.value?"primary":"default",size:"small",icon:"PriceTag",onClick:Me,circle:!0},null,8,["type"])]),_:1}),e(s,{content:"显示/隐藏Block","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{type:S.value?"primary":"default",size:"small",icon:"Box",onClick:Ne,circle:!0},null,8,["type"])]),_:1})]),n("div",Ct,[e(s,{content:g.value?"展开侧边栏":"收起侧边栏","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{class:"collapse-toggle",size:"small",onClick:Te},{default:a(()=>[e(E,null,{default:a(()=>[(T(),$(ne(g.value?"CaretRight":"CaretLeft")))]),_:1})]),_:1})]),_:1},8,["content"]),e(s,{content:b.value?"展开导航栏":"折叠导航栏","show-after":50,placement:"bottom"},{default:a(()=>[e(i,{class:"collapse-toggle",size:"small",onClick:Ee},{default:a(()=>[e(E,null,{default:a(()=>[(T(),$(ne(b.value?"CaretBottom":"CaretTop")))]),_:1})]),_:1})]),_:1},8,["content"])])]),n("div",kt,[G(n("div",{class:"left-panels",style:tt({width:k.value+"px"})},[n("div",Pt,[o[14]||(o[14]=n("div",{class:"panel-header"},[n("span",{class:"canval-title"},"视图")],-1)),n("div",Et,[e(nt)])]),n("div",Tt,[n("div",{class:"panel-header",onClick:Le},[o[15]||(o[15]=n("span",{class:"canvas-title"},"图层",-1)),e(E,{class:z(["collapse-icon",{collapsed:I.value}])},{default:a(()=>[e(B)]),_:1},8,["class"])]),G(n("div",Lt,[e(st)],512),[[K,!I.value]])])],4),[[K,!g.value]]),G(n("div",{class:z(["panel-resizer",{resizing:P.value}]),onMousedown:Ae},null,34),[[K,!g.value]]),n("div",zt,[n("div",Dt,[e(lt,{ref_key:"mapCanvasRef",ref:f,onPointDoubleClick:Re},null,512)])])]),n("div",St,[n("div",It,[n("span",Mt," X: "+C(N.value.x.toFixed(2))+", Y: "+C(N.value.y.toFixed(2)),1)])]),e(it,{modelValue:A.value,"onUpdate:modelValue":o[9]||(o[9]=u=>A.value=u),point:U.value,onUpdated:He},null,8,["modelValue","point"])])}}}),lo=at(At,[["__scopeId","data-v-31ea0e31"]]);export{lo as default};
